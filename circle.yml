machine:
  pre:
    # - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
    # - sudo pip install docker-compose
  services:
    - docker
  # environment:
    # PRODUCTION_S3_URL_FOR_LATEST_TAG: "s3://conversations-deployment/latest-bamboo-tags/production-$SERVICE_NAME_LOWER-circle"

dependencies:
  pre:
    - docker info
    - docker-compose -v
  override:
    - git submodule update --init
    - ls
    - pwd
    - cd ./mywell-server && npm install && docker build -t mywell-server .
  cache_directories:
    - "mywell-server/node_modules"

test:
  override:
    #unfortunately, no docker-compose without docker 1.10, and no lxc-attach or exec with docker 1.10, so we have to run everything ourselves
    - docker run -d --name db -e MYSQL_ROOT_PASSWORD=password -e MYSQL_DATABASE=mywell -e MYSQL_USER=mywell -e  MYSQL_PASSWORD=password mariadb:10.0
    - >
      docker run -d \
                 --name mywell-server \
                 --link db \
                 -p 3000:3000 \
                 -v $(pwd)/mywell-server/mywell-server:/usr/src/app/ \
                 -v $(pwd)/mywell-server/mywell-server/node_modules:/usr/src/app/node_modules \
                 mywell-server
    - docker ps
    - >
      sudo lxc-attach -n "$(docker inspect --format "{{.Id}}" mywell-server)" \
        -- bash -c 'pwd; ls /usr/src/app/mywell-server; /usr/src/app/mywell-server/test.sh'

# deployment:
#   master:
#     brach: master
#     commands:
#       -


  # staging:
  #   branch: staging
  #   commands:
  #     - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
  #     - docker push $IMAGE_NAME:$TAG_NAME
  #     - echo "$IMAGE_NAME:$TAG_NAME" > /tmp/last_image
  #     - echo $'[profile deployer]\nrole_arn = arn:aws:iam::997038222845:role/bamboo-Conversations-deployer\nsource_profile = default' >> ~/.aws/config
  #     - aws s3 cp /tmp/last_image $STAGING_S3_URL_FOR_LATEST_TAG --profile deployer
  #     - >
  #       cd ./conversations-deployment/tools;
  #       ./circle_deployer.py\
  #           --branch_name staging\
  #           --service_name $SERVICE_NAME\
  #           --docker_image_name $IMAGE_NAME:$TAG_NAME\
  #           --config_file_path ../vpc-configurations/vpc-definitions.yaml\
  #           --slack_api_token $SLACK_API_TOKEN
