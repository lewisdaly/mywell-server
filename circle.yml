machine:
  services:
    - docker

dependencies:
  pre:
    - docker info
  override:
    - git submodule update --init
    - ls
    - pwd
    - cd ./mywell-server && npm install && docker build -t mywell-server .
  cache_directories:
    - "mywell-server/node_modules"

test:
  override:
    #unfortunately, no docker-compose without docker 1.10, and no lxc-attach or exec with docker 1.10, so we have to run everything ourselves
    - docker run -d --name db -e MYSQL_ROOT_PASSWORD=password -e MYSQL_DATABASE=mywell -e MYSQL_USER=mywell -e  MYSQL_PASSWORD=password mariadb:10.0
    - >
      docker run -d \
                 --name mywell-server \
                 --link db \
                 -p 3000:3000 \
                 -v $(pwd)/mywell-server/:/usr/src/app/ \
                 -v $(pwd)/mywell-server/node_modules:/usr/src/app/node_modules \
                 mywell-server
    - docker ps
    - >
      sudo lxc-attach -n "$(docker inspect --format "{{.Id}}" mywell-server)" \
        -- bash -c 'pwd; ls /usr/src/app/; /usr/src/app/test.sh'

deployment:
  master:
    branch: master
    commands:
      - echo 'deploying'
      - ssh -v $DROPLET_USER@$DROPLET_IP "cd ~/mywell-server; ./circle_deployer.sh"
